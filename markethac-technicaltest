WITH report_monthly_orders_product_agg AS (
  SELECT
    FORMAT_TIMESTAMP('%Y-%m', o.created_at) AS month,
    p.id AS product_id,
    p.name AS product_name,
    SUM(oi.sale_price) AS total_sales,
    COUNT(oi.id) AS total_quantity,  -- setiap baris = 1 item, jadi pakai COUNT
    COUNT(DISTINCT o.order_id) AS total_orders
  FROM
    `bigquery-public-data.thelook_ecommerce.orders` o
  JOIN
    `bigquery-public-data.thelook_ecommerce.order_items` oi
    ON o.order_id = oi.order_id
  JOIN
    `bigquery-public-data.thelook_ecommerce.products` p
    ON oi.product_id = p.id
  WHERE
    o.status = 'Complete'
  GROUP BY
    month, p.id, p.name
)

SELECT *
FROM report_monthly_orders_product_agg
ORDER BY month, total_sales DESC;
